<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="pers.yang.mapper.SetmealMapper">

    <!--===========================insert===================================-->
    <!--添加套餐信息-->
    <insert id="addSetmeal" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        insert into t_setmeal values(null, #{name}, #{code}, #{helpCode}, #{sex}, #{age}, #{price}, #{remark}, #{attention}, #{img})
    </insert>

    <!--添加套餐和检查组关联信息-->
    <insert id="addAssoication">
        insert into t_setmeal_checkgroup values
        <foreach collection="checkgroupIds" item="checkgroupId" separator=",">
            (#{id}, #{checkgroupId})
        </foreach>
    </insert>

    <!--===========================select===================================-->
    <!--分页查询套餐数据-->
    <select id="findSetmealByCondition" resultType="pers.yang.pojo.Setmeal">
        select * from t_setmeal
        <where>
            <if test="queryString != null and queryString.trim() != ''">
                code = #{queryString} or name like '%' #{queryString} '%' or helpCode= #{queryString}
            </if>
        </where>
    </select>

    <!--查询套餐列表-->
    <select id="findAllSetmeals" resultType="pers.yang.pojo.Setmeal">
        select * from t_setmeal
    </select>
    <!--通过id查询套餐详情-->
    <select id="findSetmealDetailsById" resultMap="findSetmealDetailsResultMap">
        SELECT
            s.*, cg.id cgid, cg.name cgname, cg.remark cgremark, ci.id ciid, ci.name ciname
        FROM
            t_setmeal s
        INNER JOIN t_setmeal_checkgroup sc on s.id = sc.setmeal_id
        INNER JOIN t_checkgroup cg on sc.checkgroup_id = cg.id
        INNER JOIN t_checkgroup_checkitem cc on cc.checkgroup_id = cg.id
        INNER JOIN t_checkitem ci on cc.checkitem_id = ci.id
        where s.id = #{id}
    </select>
    <resultMap id="findSetmealDetailsResultMap" type="Setmeal" autoMapping="true">
        <!--id-->
        <id property="id" column="id"/>
        <!--检查组集合-->
        <collection property="checkGroups" javaType="List" ofType="CheckGroup" autoMapping="true">
            <id column="cgid" property="id"/>
            <result column="cgname" property="name"/>
            <result column="cgremark" property="remark"/>
            <!--检查项集合-->
            <collection property="checkItems" javaType="List" ofType="CheckItem" autoMapping="true">
                <id property="id" column="ciid"/>
                <result property="name" column="ciname"/>
            </collection>
        </collection>
    </resultMap>

    <!--通过id查询套餐-->
    <select id="findSetmealById" resultType="pers.yang.pojo.Setmeal">
        select * from t_setmeal where id = #{id}
    </select>

    <!--统计预约数量-->
    <select id="getSetmealReport" resultType="Map">
        SELECT
            count(o.id) value, s.name
        FROM
            t_order o
        INNER JOIN t_setmeal s ON o.setmeal_id = s.id
        GROUP BY
            s.id
    </select>
</mapper>